name: Update Dashboard Data

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Fetch data from n8n
      run: |
        echo "ğŸ”„ n8n'den veri Ã§ekiliyor..."
        
        if curl -s -f --connect-timeout 10 --max-time 30 "http://10.220.0.151:5678/webhook/c645dc3f-f575-48c4-ab0a-0bc30a1954bf" > data.json; then
          echo "âœ… n8n'den veri baÅŸarÄ±yla alÄ±ndÄ±"
          cat data.json
        else
          echo "âŒ n8n API eriÅŸilemedi, fallback veri oluÅŸturuluyor"
          cat > data.json << 'EOF'
        {
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "date": "$(date +%Y-%m-%d)",
          "totalCalls": 0,
          "successfulCalls": 0,
          "successRate": 0,
          "recentCalls": [],
          "error": "n8n API temporarily unavailable"
        }
        EOF
        fi
        
    - name: Update HTML with data
      run: |
        echo "ğŸ“ HTML dosyasÄ± gÃ¼ncelleniyor..."
        
        python3 << 'EOF'
        import json
        import re
        from datetime import datetime
        
        try:
            with open('data.json', 'r') as f:
                data = json.load(f)
            print("âœ… JSON verisi okundu:", data)
        except Exception as e:
            print("âŒ JSON okuma hatasÄ±:", e)
            data = {
                "timestamp": datetime.utcnow().isoformat() + "Z",
                "totalCalls": 0,
                "successfulCalls": 0,
                "successRate": 0,
                "recentCalls": []
            }
        
        try:
            with open('index.html', 'r', encoding='utf-8') as f:
                html_content = f.read()
            print("âœ… HTML dosyasÄ± okundu")
        except Exception as e:
            print("âŒ HTML okuma hatasÄ±:", e)
            exit(1)
        
        js_data_block = f'''        const LIVE_DATA = {json.dumps(data, indent=8)};
        const LAST_UPDATE = '{datetime.now().strftime("%d.%m.%Y %H:%M")}';'''
        
        pattern = r'(\s*const LIVE_DATA = .*?;\s*const LAST_UPDATE = .*?;)'
        
        if re.search(pattern, html_content, re.DOTALL):
            html_content = re.sub(pattern, '\n' + js_data_block + '\n        ', html_content, flags=re.DOTALL)
            print("âœ… Mevcut veri bloÄŸu gÃ¼ncellendi")
        else:
            print("âŒ Veri bloÄŸu bulunamadÄ±")
            exit(1)
        
        try:
            with open('index.html', 'w', encoding='utf-8') as f:
                f.write(html_content)
            print("âœ… HTML dosyasÄ± gÃ¼ncellendi")
            print(f"ğŸ“Š Toplam arama: {data.get('totalCalls', 0)}")
        except Exception as e:
            print("âŒ HTML yazma hatasÄ±:", e)
            exit(1)
        EOF
        
    - name: Commit and push changes
      run: |
        echo "ğŸ“¤ DeÄŸiÅŸiklikler GitHub'a gÃ¶nderiliyor..."
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        if git diff --quiet; then
          echo "â„¹ï¸ GÃ¼ncellenecek deÄŸiÅŸiklik bulunamadÄ±"
        else
          git add index.html data.json
          git commit -m "ğŸ¤– Otomatik dashboard gÃ¼ncellemesi - $(date '+%d.%m.%Y %H:%M UTC')"
          git push
          echo "âœ… Dashboard baÅŸarÄ±yla gÃ¼ncellendi"
        fi
